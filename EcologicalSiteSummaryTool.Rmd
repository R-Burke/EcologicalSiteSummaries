---
title: "Ecological Site Summaries" 
subtitle: "Using Assessment, Inventory, and Monitoring Data"
author: "Rachel Burke, Jornada"
date: "09/04/2019"
output:
  html_document:
    theme: cosmo

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE , message = FALSE , warning = FALSE)
```

<style>
p.caption {
  font-size: 0.9em;
  font-style: italic;
  color: grey;
  margin-right: 0%;
  margin-left: 0%;  
  text-align: right;
}
</style>


```{r banner , fig.height = 4 , fig.width = 10 , fig.cap= "photo by Patrick Alexander"}

knitr::include_graphics("C:/Users/rburke/Documents/Playa.jpg")

```

# 1. Introduction {.tabset .tabset-fade .tabset-pills}
##
## About Ecological Sites

The U.S. Department of Agriculture Natural Resources Conservation Service (NRCS) defines ecological sites as "a distinctive kind of land with specific physical characteristics that differs from other kinds of land in its ability to produce a distinctive kind and amount of vegetation" ([USDAâ€“NRCS, 2006](https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/landuse/rangepasture/?cid=stelprdb1068392)). Ecological sites determine not only the ecological potential of a site, but also how a site can respond to natural disturbance and management actions. Ecological sites have been delineated for many areas using physical and biotic features and are linked to soil map units. Soils, climate, hydrology, geology, physiographic features, plants species occurrences, plant community composition, annual biomass production, and plant-wildlife interactions all contribute to the proerties of ecological sites.  Ecological Site Descriptions (ESDs) describe the underlying factors associated with a specific ecological site, as well as different ecological states within a given site based on factors such as grazing, fire, drought, and other management actions. For an example of an ESD, see [EDIT Jornada](https://edit.jornada.nmsu.edu/page?content=class-description&catalog=3&spatial=84&class=5802#top-bookmark).


## Ecological Site Summary

Using ecological monitoring data, the overall status of an Ecological Site can be summarized into an Ecological Site Summary (ESS). At the site level, ecological site summaries generated from monitoring data can tell us about the condition and health of ecological sites based on indicators such as cover by structure and functional group, species dominance, species occurrences, canopy gap measurements, and soil stability measurements. These indicators can help inform the user of the ecological state of a givenplot or overall site (i.e. shrubland state vs. grassland state). Identifying the ecological state allows us to not only determine the degree of departure from the corresponding reference ecological states, but also to inform management and restoration actions accordingly by determining the best pathway to a less degraded state. For more on state and transition models (STMs), see see [Bestelmeyer et al., 2017](https://link.springer.com/content/pdf/10.1007%2F978-3-319-46709-2_9.pdf). 
A major data source for developing these summaries is the Assessment, Inventory, and Monitoring (AIM) Program along with the Landscape Monitoring Framework (LMF). AIM and LMF include almost 25,000 plots throughout the western United States (*see* [AIM Data Portal](https://aim.landscapetoolbox.org/data-management-project-evaluation/databases/)) stored in the Terrestrial AIM Database (TerrADat). Data garnered from AIM and LMF plots is both generalizable and scalable and thus applicable to management decisions across multiple disciplines at both local and national levels. 

## Using the ESS Tool

An Ecological Site Summary (ESS) tool has been developed to help users visualize the overall status of their region of interest within a specific ecological site, or across an ecological site group. This information can be summarized within a given administrative state or across political boundaries for landscape scale analysis. Ecological site summaries are generated using an R Markdown script with an interactive HTML output in which users can query summary tables, download full or filtered summary tables to view in Excel, explore interactive plots, and download static plots for their own use. The script to generate this report is available [here](https://github.com/R-Burke/EcologicalSiteSummaries/blob/master/EcologicalSiteSummaryReport_09032019.Rmd). For those who prefer to not use R or who have restrictins on using R on their computers, fill out this [template](https://github.com/R-Burke/EcologicalSiteSummaries/blob/master/ESS_Template.xlsx) to request a report from Jornada.

This repoert is an automatied process and can be continually updated as new data becomes available each year or as lines of inquiry shift. This ESS information can be included in decision making processes for BLM managers, as it can help inform land use plans, grazing permit renewals, shrub or invasive species treatments, and/or seed menu development for ecological restoration and reclamation. In cases where ESDs are not developed, grouping AIM data by other features can provide similar information, and potentially lead to the development of new ESDs. It may be informative to group by features such as watershed units, soil map units, biophysical settings, or grazing allotments. Grouping indicators by other spatial attributes is available in a customized report (*see page 2 in the report template).  


## Getting set up

If you plan on running this tool yourself, please read this section. If you are requesting Jornada to run your report, you can ignore this section. 

**BLM Users:** make sure you have R installed on your local drive and that packages are being installed on your local drive as well. You most likely will not be able to render this report on a network drive. 



``` {r ESS Demo, echo = FALSE, include = FALSE}
#Load required packages
#If you are generating this report yourself, make sure all of the following packages have been installed
#BLM users- Make sure you install packages (and R) to your local drive (i.e. "C:\users\jsmith\Documents\R)
#This script was written using R 3.5.3

devtools::install_github("smccord/terradactyl") #terradactyl shouldn't be necessary after accumulated species is loaded as its own table

library(tidyverse)
library(knitr)
library(kableExtra)
library(leaflet)
library(patternplot)
library(magrittr)
library(rgdal)
library(RColorBrewer)
library(units)
library(sp)
library(sf)
library(rworldmap)
library(rworldxtra)
library(raster)
library(plotly)


```

# 2. About Boxplots {.tabset .tabset-fade .tabset-pills}

This report uses boxplots to summarize cover values into quartiles while keeping outliers visible. The figures in this report are interactive within the tool. Hovering over the dots on the plot will give you the Plot ID of the plot from which the measure was obtained, as well as the individual species from which the measurement was obtained if applicable. Hovering over the boxplot will give you quartile values. The interactive figures can be downloaded as static figures to incorporate into reports.
*The following image explains how to interpret a boxplot.* 

##
## Boxplot

```{r boxlot fig , include = TRUE , fig.height = 6 , fig.width = 8 , echo = FALSE , fig.cap = "1 Modified from: https://www.wellbeingatschool.org.nz/information-sheet/understanding-and-interpreting-box-plots  (accessed 22 Aug2019)" }

knitr::include_graphics("C:/Users/rburke/Documents/RFiles/EcologicalSiteSummaryDemo/boxplot_text.png")


```

# 3. Prepping the Data {.tabset .tabset-fade .tabset-pills}

##
## Required Inputs 

To generate these reports, several inputs are required. These include your state, your ecological site(s) of interest, and directions to the TerrADat geodatabase. After directing the tool to the right place and specifying your state and ecological site(s), these reports are automated. Additional shapefiles can also be included for finer groupings. \
*Note: these reports only work with a state species list.*


## Define your ecological site(s) , state, and file paths


```{r file paths , echo = TRUE , include = TRUE}

#Set file path to TerrADat

TerrADatPath <- "~/GDBs/SDE_Export.gdb"
                #The state species list table should also live in this geodatabase

#Define your state

#Define your ecological site

EcoSite <- c("R023XF082CA")

#Define the path to any shapefile you want to use from grouping data

Shapefile_path <- "~/GDBs/SDD_NorCal_2013ESR_SDD.gdb" #path to gdb that contains shapefile (allotment in this case)

Shapefile_name <- "Terra_Sample_Frame" #Name of shapefile

```

```{r read in files , echo = FALSE , include = FALSE}

TerrADat <- rgdal::readOGR(dsn = TerrADatPath , "TerrADat")

LMF <- rgdal::readOGR(dsn = TerrADatPath , "LMF")

TerrADat_Species <- rgdal::readOGR(dsn = TerrADatPath , "TerrADatSpeciesIndicators")

LMF_Species <- rgdal::readOGR(dsn = TerrADatPath , "LMFSpeciesIndicators")


#Save as a dataframe

TerrADat <- as.data.frame(TerrADat)

LMF <- as.data.frame(LMF)

TerrADat_Species <- as.data.frame(TerrADat_Species)

LMF_Species <- as.data.frame(LMF_Species)

LMF_EcoSite <- LMF %>% mutate(EcologicalSiteId2 = paste0("R" , LMF$EcologicalSiteId)) %>% dplyr::select(-EcologicalSiteId) 

LMF <- LMF_EcoSite %>% rename(EcologicalSiteId = EcologicalSiteId2)


#Bind LMF and TerrADat

TerrADat[setdiff(names(LMF) , names(TerrADat))] <- NA
LMF[setdiff(names(TerrADat), names(LMF))] <- NA

TDat_LMF <- rbind(TerrADat , LMF)


#Bind LMF and TerrADat Species Indicators

#First need names to match, TDat species got cut off (comment this out if did not first export to shapefile)

TerrADat_Species <- TerrADat_Species %>% rename(AH_SpeciesCover = AH_Species , Hgt_Species_Avg = Hgt_Specie , AH_SpeciesCover_n  = AH_Speci_1 , 
                                                Hgt_Species_Avg_n = Hgt_Spec_1 , GrowthHabit = GrowthHabi , GrowthHabitSub = GrowthHa_1 , 
                                                SpeciesState = SpeciesSta , created_user = created_us , created_date = created_da , 
                                                last_edited_user = last_edite , laste_edited_date = last_edi_1 )

#place NAs in non-matching columns
LMF_Species[setdiff(names(TerrADat_Species) , names(LMF_Species))] <- NA
TerrADat_Species[setdiff(names(LMF_Species), names(TerrADat_Species))] <- NA

Species_indicator <- rbind(TerrADat_Species , LMF_Species)

head(Species_indicator)


##Caption to use in your tables and plots

Caption <- paste0("Cover Summaries for Ecological Site" , EcoSite) 

#Subset your ecological site and state


#Pull out year for map

TDat_LMF_plots_Year <- separate(TDat_LMF, DateEstablished , into = c("Year" , "Month" , "Day"), sep = "/") %>% 
                    filter(!is.na(EcologicalSiteId)) %>% filter(!is.na(Year)) %>% filter(!is.na(Latitude_NAD83)) %>%
                    filter(!Latitude_NAD83 <= 1) %>% arrange(EcologicalSiteId) #Sorting this for the map and remove 0,0 lat lon


#PSubset based on EcologicalSiteId

EcoSitePlots <- TDat_LMF[TDat_LMF[["EcologicalSiteId"]] %in% EcoSite, ] #for non-species indicators

EcoSite_PKs <- EcoSitePlots$PrimaryKey

#Keeping only the plots from accumulated species that match our EcoSite

Species_plots_ecosite <- Species_indicator[(Species_indicator[["PrimaryKey"]] %in% EcoSite_PKs), ]
Species_plots_ecosite <- Species_plots_ecosite %>% mutate(Tally = 1) #For getting sample size in species indicators

###That's all the subsetting necessary

```

# 4. Where is this data coming from? {.tabset .tabset-fade .tabset-pills}
##
## Plot Map \

Below is a map of  plots surveyed to date (*this will change when written with full internal TerrADat*). 
Plots in our ecological site of interest are highlighted in red. \

```{r map , echo = FALSE , include = FALSE}

#Set colors based on ecological site id, date, etc. This is flexible

Pal_EcoSite <- colorFactor(palette = 'YlOrRd' , domain = TDat_LMF_plots_Year$EcologicalSiteId)

Pal_Date <- colorFactor(palette = 'Greys' , domain = TDat_LMF_plots_Year$Year)

Pal_EcoSiteID <- colorFactor(palette = "Red" , domain = EcoSite)

EcoSite_All <- TDat_LMF_plots_Year$EcologicalSiteId

Year <- TDat_LMF_plots_Year$Year

EcoSite_All <- as.character(EcoSite_All) #for if we want to add all ecosites to the legend

Map <- leaflet(height = 650 , width = 650)


Map <- addTiles(Map) %>% addCircleMarkers(lng = ~Longitude_NAD83 , lat = ~Latitude_NAD83 , radius = 3 , 
                                          popup = ~EcologicalSiteId,
                                          color = ~Pal_Date(Year) , 
                                          fillOpacity = .5 , group = Year , 
                                          data = TDat_LMF_plots_Year) %>% 
                                          addCircleMarkers(lng = ~Longitude_NAD83 , lat = ~Latitude_NAD83 , 
                                                           radius = 3 , 
                                                           fillOpacity = 0.5 , 
                                                           popup = ~EcologicalSiteId ,
                                                           color = "red" , group = EcoSite , 
                                                           data = EcoSitePlots) %>% 
                                          addLayersControl(overlayGroups = c(EcoSite , Year) ,
                                          options = layersControlOptions(collapsed = TRUE)) %>%
                                          addLegend(pal = Pal_Date , values = TDat_LMF_plots_Year$Year , opacity = 1 , group = Year) %>%
                                          addLegend(pal = Pal_EcoSiteID , values = EcoSite , opacity = 1 , group = EcoSite)
                                          

```

```{r interactive map, echo = FALSE , include = TRUE}

Map

```


```{r plots per year , echo = FALSE , include = FALSE}

Plots <- c("Plots")

Year_Palette <- c("2008" = "grey97" , "2009" = "grey87" , "2010" = "grey77" , "2011" = "grey70" , "2012" = "grey65" , 
                  "2013" = "grey60" , "2014" = "grey50" , "2015" = "grey45" , "2016" = "grey40" , "2017" = "grey35" ,
                  "2018" = "grey30" , "2019" = "grey25" , "2020" = "grey20" , "2021" = "grey15")

Plots_Simple <- TDat_LMF_plots_Year %>% dplyr::select(PrimaryKey , Year , EcologicalSiteId) %>% mutate(Plots = Plots) %>%
                arrange(Year)

Plots_Simple_EcoSite <- Plots_Simple[Plots_Simple[["EcologicalSiteId"]] %in% EcoSite, ] 

PlotsPerYear_Total <- ggplot(Plots_Simple , aes(Plots)) +
                geom_bar(stat = "count" , position = position_stack(reverse = TRUE) , 
                         aes(fill = Year) , width = .2 , ) +
                scale_fill_manual(values = Year_Palette) +
                coord_flip() + theme(axis.text.y = element_blank())


PlotsPerYear_EcoSite <- ggplot(Plots_Simple_EcoSite , aes(Plots)) +
                geom_bar(stat = "count" , position = position_stack(reverse = TRUE) , 
                         aes(fill = Year , text = EcologicalSiteId) , width = .2 , ) +
                scale_fill_manual(values = Year_Palette) +
                coord_flip() + theme(axis.text.y = element_blank())

EcologicalSitesPerYear <- ggplot(Plots_Simple , aes(EcologicalSiteId))+
                geom_bar(stat = "count" , position = position_stack(reverse = TRUE) , 
                         aes(fill = Year) ) +
                scale_fill_manual(values = Year_Palette) +
                coord_flip() 


```


## Plots Per Year, All Ecological Sites

```{r plots figure , echo = FALSE , include = TRUE , fig.height = 3 , fig.width = 8 , fig.cap = "Total Plots Per Year, AIM & LMF"}

PlotsPerYear_Total <- ggplotly(PlotsPerYear_Total)
PlotsPerYear_Total

```

## Plots Per Year, Your Ecological Sites

```{r plots figure 2 , echo = FALSE , include = TRUE , fig.height = 3 , fig.width = 8, fig.cap = "Plots Per Year in Ecological Site, AIM & LMF"}

PlotsPerYear_EcoSite <- ggplotly(PlotsPerYear_EcoSite)
PlotsPerYear_EcoSite

```


## Plots Per Ecological Site Per Year

<style>

.ScrollStyle{
    max-height: 500px;
    overflow-y: scroll;
}

</style>

<div class = "ScrollStyle">

```{r ecosite plot , echo = FALSE , include = TRUE , fig.width = 8,  fig.height = 60 }

EcologicalSitesPerYear <- ggplotly(EcologicalSitesPerYear)
EcologicalSitesPerYear

```

</div>

# 5. Species Cover Summaries {.tabset .tabset-fade .tabset-pills}

These summaries use data from Line-point intercept (LPI) method to determine average cover of individual species, as well as summaries by structure and functional group cover, noxious versus non-noxious cover, and woody vs. non-woody cover. From the AIM data, we can make some simple figures showing cover values. These figures, along with the summary tables, can quickly be incorporated into any documents where this data is used (i.e. NEPA documents for grazing permit renewals, shrub treatments, etc).

```{r species cover , echo = FALSE , include = FALSE}

Species_plots_ecosite_minusState <- Species_plots_ecosite %>% dplyr::select(-SpeciesState)
                                    
#get species list for full names

SpeciesList<- sf::st_read(dsn = TerrADatPath ,  
                             layer = "tblStateSpecies") 

SpeciesList <- SpeciesList %>% rename(Species = SpeciesCode)  %>% dplyr::select(-SpeciesState) %>% distinct(SpeciesList)

Species_cover_summary <- Species_plots_ecosite_minusState %>% filter(!is.na(AH_SpeciesCover)) %>% #ignored NAs- make disclosure as this may overestimate cover 
                         group_by(Species , GrowthHabit , GrowthHabitSub , Noxious) %>% summarize(AveragePercentCover = mean(AH_SpeciesCover) , 
                         StandardDeviation = sd(AH_SpeciesCover),
                         MinCover = min(AH_SpeciesCover) , 
                         MaxCover = max(AH_SpeciesCover) , n = sum(Tally)) %>%
                         mutate_if(is.numeric, round , digits = 2)



Species_cover_summary <- merge(Species_cover_summary , SpeciesList , by = "Species")
                             

Species_cover_summary <- Species_cover_summary %>% rename(GrowthHabit = GrowthHabit.x , GrowthHabitSub = GrowthHabitSub.x , 
                                                          Noxious = Noxious.x) %>% dplyr::select(Species, ScientificName, 
                                                          AveragePercentCover, StandardDeviation,
                                                          MinCover , MaxCover , n , Family , GrowthHabit , 
                                                          GrowthHabitSub , Duration, Noxious , SG_Group , 
                                                          SynonymOf , CommonName , 
                                                          Notes , UpdatedSpeciesCode) 


Species_cover_summary <- Species_cover_summary[!duplicated(Species_cover_summary$Species), ]

##Setting color palette for plot

NoxNonPal_Fill <- c("grey75"  , "#D55E00")

NoxNonPal_Dot <- c("grey33" , "#993300")

##Prepping data for plots

Species_plots_ecosite <- Species_plots_ecosite %>% mutate_if(is.numeric, round , digits = 2)

# Pulling out grass/forb vs. only perennial plants.

SFG_Plots <- lapply(X = split(Species_plots_ecosite, Species_plots_ecosite[["GrowthHabitSub"]] , drop = TRUE), FUN = function(Species_plots_ecosite){

  current_plot <- ggplot(Species_plots_ecosite , aes(x = GrowthHabitSub , y = AH_SpeciesCover)) +
                                                                  geom_boxplot(width = .6 , outlier.shape = NA) +
                                                                  geom_jitter(width = .45 , size = 1.25, aes(color = Noxious, 
                                                                  text = paste("Plot ID: ", PlotID, 
                                                                               "Species: " , '<br>' , Species))) + 
                                                                  scale_color_manual(values = NoxNonPal_Dot) + 
                                                                  theme_light() + 
                                                                  labs(y = "Percent Cover") + 
                                                                  scale_y_continuous(limits = c(0 , 100))  +
                                                                  theme(axis.text.y = element_blank() , axis.ticks.y = element_blank() , 
                                                                  axis.line.y = element_blank()) + theme(panel.grid.major.y = element_blank() , 
                                                                                                         axis.title.y = element_blank()) +
                                                                  ggtitle("Percent Cover by Functional Group") +
                                                                  coord_flip() + facet_grid(cols = vars(GrowthHabitSub) , 
                                                                                            rows = vars(Duration) , switch = "y" , 
                                                                                            scales = "free" , drop = TRUE) 

return(current_plot)
})



#Split to plot individual species, split by duration and growth habit

Species_Plots <- lapply(X = split(Species_plots_ecosite, Species_plots_ecosite[["GrowthHabitSub"]] , drop = TRUE), FUN = function(Species_plots_ecosite){

  current_plot <- ggplot(Species_plots_ecosite , aes(x = Species , y = AH_SpeciesCover)) +
                    geom_boxplot(width = .6 , outlier.shape = NA) +
                    geom_jitter(width = .15 , size = 1 , aes(color = Noxious , text = paste("Plot ID: ", PlotID, 
                    "Primary Key: " , PrimaryKey))) + 
                    scale_color_manual(values = NoxNonPal_Dot) + scale_y_continuous(limits = c(0 , 100)) + 
                    theme_light() + 
                    labs(y = "Percent Cover") + ggtitle(paste("Percent Cover by Species, " , Species_plots_ecosite$GrowthHabitSub)) + theme(axis.title.y = element_blank()) +
                    coord_flip() +  facet_grid(cols = vars(GrowthHabitSub) , rows = vars(Duration) , 
                    switch = "y" , scales = "free_y" , drop = TRUE) 

return(current_plot)
})


#Noxious vs NonNoxious Cover Plot

Nox_Non <- (Species_plots_ecosite) %>% group_by(Noxious) %>% filter(!is.na(Noxious)) %>% filter(!is.na(AH_SpeciesCover))

Nox_Non$Noxious <- gsub("YES" , "Yes", Nox_Non$Noxious) 

Nox_Non$Noxious <- gsub("NO", "No", Nox_Non$Noxious)

Nox_Non_Plot <- ggplot(data = Nox_Non , (aes(x = Noxious , y = AH_SpeciesCover))) +
                                                 geom_boxplot(width = .6 , outlier.shape = NA) +
                                                 geom_jitter(width = .15 , size = 1.25 , aes(color = Noxious , text = paste("Plot ID: ", PlotID, 
                                                 "Primary Key: " , PrimaryKey))) + 
                                                 scale_color_manual(values = NoxNonPal_Dot) +
                                                 theme_light() + 
                                                 scale_y_continuous(limits = c(0 , 100)) +
                                                 labs(y = "Percent Cover") + ggtitle("Percent Cover, Noxious vs. Non-Noxious Species") + 
                                                 theme(axis.title.y = element_blank() , axis.text.y = element_blank() , axis.ticks.y = element_blank() , 
                                                                  axis.line.y = element_blank() , panel.grid.major.y = element_blank() , legend.position = "none") +
                                                                  coord_flip() + facet_grid(rows = vars(Noxious) , 
                                                                  switch = "y" , scales = "free" , drop = TRUE) 
                                                
Nox_Non_Plot <- ggplotly(Nox_Non_Plot)


```
##

## Plots {.tabset .tabset-fade .tabset-pills}

###

### Cover by Functional Group {.tabset .tabset-fade .tabset-pills}

####

#### Graminoid

```{r SFG plots grass , fig.height = 5 , fig.width = 10 , echo = FALSE, include = TRUE}

Graminoid_SFG <- ggplotly(SFG_Plots[["Graminoid"]])
Graminoid_SFG

```

#### Forb

```{r SFG plots forb , fig.height = 5 , fig.width = 10 , echo = FALSE, include = TRUE}

Forb_SFG <- ggplotly(SFG_Plots[["Forb"]])
Forb_SFG
```

#### Sub Shrub

```{r SFG plots subshrub , fig.height = 5 , fig.width = 10 , echo = FALSE, include = TRUE}
SubShrub_SFG <- ggplotly(SFG_Plots[["SubShrub"]])
SubShrub_SFG
```

####  Shrub

```{r SFG plots shrub , fig.height = 5 , fig.width = 10 , echo = FALSE, include = TRUE}
Shrub_SFG <- ggplotly(SFG_Plots[["Shrub"]])
Shrub_SFG

```

####  Tree

```{r SFG plots tree , fig.height = 5 , fig.width = 10 , echo = FALSE, include = TRUE}
Tree_SFG <- ggplotly(SFG_Plots[["Tree"]])
Tree_SFG

```

####  Succulent

```{r SFG plots succulent , fig.height = 5 , fig.width = 10 , echo = FALSE, include = TRUE}
Succulent_SFG <- ggplotly(SFG_Plots[["Succulent"]])
Succulent_SFG

```

### Cover by Noxious, Non-Noxious Species 

```{r nox plots , fig.height = 4 , fig.width = 10 , echo = FALSE, include = TRUE}

Nox_Non_Plot

```

### Cover by Species {.tabset .tabset-fade .tabset-pills}

####

#### Graminoid

<div class = "ScrollStyle">


```{r species plots grass , fig.height = 15 , fig.width = 10 , echo = FALSE, include = TRUE , results = 'asis'}

Graminoid_Species <- ggplotly(Species_Plots[["Graminoid"]])
Graminoid_Species
```

</div>

#### Forb

<div class = "ScrollStyle">


```{r species plots forb , fig.height = 15 , fig.width = 10 , echo = FALSE, include = TRUE , results = 'asis'}
Forb_Species <- ggplotly(Species_Plots[["Forb"]])
Forb_Species
```

</div>

#### Sub Shrub

<div class = "ScrollStyle">


```{r species plots subshrub , fig.height = 15 , fig.width = 10 , echo = FALSE, include = TRUE , results = 'asis'}
SubShrub_Species <- ggplotly(Species_Plots[["SubShrub"]])
SubShrub_Species
```

</div>


#### Shrub

<div class = "ScrollStyle">

```{r species plots shrub , fig.height = 15 , fig.width = 10 , echo = FALSE, include = TRUE , results = 'asis'}
Shrub_Species <- ggplotly(Species_Plots[["Shrub"]])
Shrub_Species
```

</div>

#### Tree

<div class = "ScrollStyle">

```{r species plots tree , fig.height = 15 , fig.width = 10 , echo = FALSE, include = TRUE , results = 'asis'}
Tree_Species <- ggplotly(Species_Plots[["Tree"]])
Tree_Species
```

</div>

#### Succulent

<div class = "ScrollStyle">
```{r species plots succulent , fig.height = 15 , fig.width = 10 , echo = FALSE, include = TRUE , results = 'asis'}
Succulent_Species <- ggplotly(Species_Plots[["Succulent"]])
Succulent_Species
```


```{r tables , echo = FALSE, include = TRUE}

#noxious vs non

NoxNNox <- Species_plots_ecosite %>% group_by(Noxious) %>% filter(!is.na(AH_SpeciesCover)) %>%
           summarize(AveragePercentCover = mean(AH_SpeciesCover) , 
                         StandardDeviation = sd(AH_SpeciesCover),
                         MinCover = min(AH_SpeciesCover) , 
                         MaxCover = max(AH_SpeciesCover) , n = sum(Tally)) %>%
                         mutate_if(is.numeric, round , digits = 2)

#SFG 

Summary_SFG_State <- Species_plots_ecosite %>% filter(!is.na(AH_SpeciesCover)) %>%
                         group_by(GrowthHabitSub, Duration) %>%
                         summarize(AveragePercentCover = mean(AH_SpeciesCover) , 
                         StandardDeviation = sd(AH_SpeciesCover),
                         MinCover = min(AH_SpeciesCover) , 
                         MaxCover = max(AH_SpeciesCover) , n = sum(Tally)) %>%
                         mutate_if(is.numeric, round , digits = 2)

                         # n = # of plants within each group for the calculation

#subsetting Average > 0 removes species codes that did not occur on that ecological site
#species with cover values = 0 may still be present on species list from spp. inventory

#woody vs. non-woody

Summary_Woody_State <- Species_plots_ecosite %>% filter(!is.na(AH_SpeciesCover)) %>%
                         group_by(GrowthHabit) %>%
                         summarize(AveragePercentCover = mean(AH_SpeciesCover) , 
                         StandardDeviation = sd(AH_SpeciesCover),
                         MinCover = min(AH_SpeciesCover) , 
                         MaxCover = max(AH_SpeciesCover)) %>% 
                         subset(AveragePercentCover > 0.0000) %>%
                         mutate_if(is.numeric, round , digits = 2)
                        
                         #subsetting Average > 0 removes species codes that did not occur on that ecological site
                         #species with cover values = 0 may still be present on species list from spp. inventory

```

## Summary Tables {.tabset .tabset-fade .tabset-pills}
###
### Percent Cover by Species <a name = "speciestable"></a>

```{r species, echo = FALSE , resutls = 'asis' , fig.height = 8}


Species_cover_summary %>%  DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)

```


### Percent Cover by Structure and Functional Group <a name = "sfg"></a>

```{r SFG , echo = FALSE , results = 'asis'}

Summary_SFG_State %>% filter(!is.na(GrowthHabitSub)) %>% 
                          DT::datatable(extensions = 'Buttons', filter = "top" ,  options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)
                       

```


### Percent Cover, Noxious vs. Non-Noxious <a name = "noxious"></a>

```{r noxious , echo = FALSE , results = 'asis'}

NoxNNox %>% filter(!is.na(Noxious)) %>%  DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)
```


### Percent Cover, Woody vs. Non-Woody <a name = "woody_non"></a>

```{r woody , echo = FALSE , results = 'asis'}

Summary_Woody_State %>% filter(!is.na(GrowthHabit)) %>% DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)

```


## Trace Species {.tabset .tabset-fade .tabset-pills}

It is unlikely that all species on a plot will be detected in line point intercept. It can be inferred that these species that were never detected in LPI have "low abundance" across this ecological site. To determine all species detected on plots throughout an ecological site (or other grouping feature), we can pull in all species detected from all other methods using the accumulated species indicator. This can give us an idea of overall diversity across the ecological site, indicate seed bank and restoration potential, and inform us more about community composition and species trends as plots are repeatedly surveyed.

```{r trace species , echo = FALSE , include = FALSE}

#Detected in richness only on plot

RichnessPresent <- Species_plots_ecosite %>% filter(is.na(AH_SpeciesCover))

#Detected in LPI on plot
LPI_Present <- Species_plots_ecosite %>% filter(AH_SpeciesCover > 0.000000)

#Removes duplicates
LPI_Present_String <- unique(LPI_Present$Species)

#Removes values from richness that also occurred in LPI
RichnessSpecies_Only <- RichnessPresent[!(RichnessPresent[["Species"]] %in% LPI_Present_String),]

#Removes duplicates
TraceCover_List <- unique(RichnessSpecies_Only$Species)

#Get into dataframe (just select state species that were trace)

TraceSpeciesCover <- SpeciesList[SpeciesList[["Species"]] %in% TraceCover_List,]

#Merge with species list to get SFF, scientific name, etc. 

TraceCover_Table_SpList <-TraceSpeciesCover %>%
                           dplyr::select(Species, ScientificName , Family , GrowthHabit , 
                              GrowthHabitSub , Duration, Noxious , SG_Group , 
                              SynonymOf , CommonName , 
                              Notes , UpdatedSpeciesCode)

```

###
### Trace Species Table

```{r trace species table , echo = FALSE , results = 'asis'}

TraceCover_Table_SpList %>% DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)

```


# 6. Ground Cover Summaries {.tabset .tabset-fade .tabset-pills}

In addition to species-specific indicators, we can summarize ground cover indicators to get percent cover values for bare ground, total rock, total litter, and total foliar. Additional indicators that can be included here are Lichen ("LC") , Moss ("M") , Duff ("D"), and/or Cyanobacteria ("CY"). These calculations are informative for assessing the status of the ecological site as a whole, susceptibility to erosion, and/or cross-walking AIM data to [Rangeland Health Assessments](https://www.landscapetoolbox.org/manuals/iirhv5/) when used in conjunction with species specific calculations. 

```{r GroundCoverIndicators , echo = FALSE , include = FALSE}


#BareSoilCover
#TotalFoliarCover
#FH_TotalLitterCover
#FH_RockCover

GroundCoverIndicators <- TerrADat %>% subset(EcologicalSiteId == EcoSite) %>% 
                         dplyr::select(BareSoilCover , TotalFoliarCover , FH_TotalLitterCover , FH_RockCover)

Ground_Cover_Tall <- gather(GroundCoverIndicators , key = Indicator , value = Percent)


#Summary table
GroundCoverSummary <- Ground_Cover_Tall %>% group_by(Indicator) %>%
                      summarize(Average = mean(Percent) , 
                      Standard_Deviation = sd(Percent) ,
                      Low = min(Percent) , 
                      High = max(Percent)) %>%
                      mutate_if(is.numeric, round , digits = 2)
#Summary plot

GroundCover_Plot <- ggplot(Ground_Cover_Tall , (aes(x = Indicator , y = Percent))) +
                    geom_boxplot(width = .6 , outlier.shape = NA) +
                    geom_jitter(width = .15) + 
                    theme_light() + 
                    scale_y_continuous(limits = c(0 , 100)) +
                    labs(y = "Ground Cover (%)" , x = "Indicator") + 
                    theme(axis.text.y = element_blank() , axis.ticks.y = element_blank() , 
                    axis.line.y = element_blank()) + theme(axis.title.x = element_text(vjust=-4) ,
                                                      axis.title.y = element_text(hjust=-5)) +
                    coord_flip() + facet_grid(rows = vars(Indicator) , 
                    switch = "y" , 
                    scales = "free_y" , drop = TRUE) 
  
```

##
## Ground Cover Plot 

```{r LPI ground plot , echo = FALSE , fig.height = 6 , fig.width = 10 , results = 'asis'}

GroundCover_Plot

```

## Ground Cover Summary Table 

```{r LPI ground cover table , echo = FALSE , results = 'asis'}

GroundCoverSummary %>%  DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)

```


# 7. Vegetation Heights {.tabset .tabset-fade .tabset-pills}

Looking at height data in conjunction with canopy gap data helps inform the vegetation structure across a site. 

```{r heights prep, echo = FALSE , include = FALSE}
#Summarizing by species across an ecosite
#maybe don't subset until the end so that the calcs are done across ecosites

HgtPrep <- Species_plots_ecosite %>% filter(!is.na(Hgt_Species_Avg)) %>% filter(!is.na(GrowthHabitSub))

#Consider merging this with species list in cases where Growth habit not populated for some states

Heights_Summary_SFG <- HgtPrep %>% group_by(GrowthHabitSub , Duration) %>%
                       summarize(AverageHeight_cm = mean(Hgt_Species_Avg) , 
                       Standard_Deviation_cm = sd(Hgt_Species_Avg),
                       MinHeight_cm = min(Hgt_Species_Avg) , 
                       MaxHeight_cm = max(Hgt_Species_Avg))%>%
                       mutate_if(is.numeric, round , digits = 2)

#Plot prep

HgtPrep_Plot <- HgtPrep %>% group_by(PrimaryKey , GrowthHabit)

Height_Plot <- ggplot(HgtPrep_Plot, aes(x = GrowthHabit , y = Hgt_Species_Avg)) +
                        geom_boxplot() + 
                        geom_jitter(width = .1 , aes(text = paste("Plot ID: ", PlotID, 
                                                      "Primary Key: " , PrimaryKey))) + 
                        labs(x = "Growth Habit" , y =  "Average Height, cm") + 
                        theme(axis.text.y = element_blank() , axis.ticks.y = element_blank() , 
                        axis.line.y = element_blank()) + theme(axis.title.x = element_text(vjust=-4) ,
                                                          axis.title.y = element_text(hjust=-5)) +
                        coord_flip() +
                        theme_light() + facet_grid(rows = vars(GrowthHabitSub) , 
                        switch = "y" , 
                        scales = "free_y" , drop = TRUE) 
```

##
## Woody and Non-Woody Heights Plot <a name = "heightswoodynon"></a>

```{r heights plot , fig.height = 6 , fig.width = 10 , echo = FALSE , include = TRUE}

Height_Plot

```

## Woody and Non-Woody Heights Tables <a name = "heightstables"></a>


```{r heights table , echo = FALSE , include = TRUE}

Heights_Summary_SFG %>%  DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)

```


# 8. Canopy Gap  {.tabset .tabset-fade .tabset-pills}

Canopy gap intercept can inform us about potential wind erosion, weed invasion, and wildlife habitat. When combined with vegetation height measurements, gap measurements can inform us about vegetation structure (see p. 41 in the [Monitoring Manual](https://www.landscapetoolbox.org/wp-content/uploads/2016/02/MMGSSE_20170614.pdf) for methods). Canopy gap, bare soil, and vegetation heights can also be used to determine thresholds at which vegetation structure may lead to a shift in ecological states. 

```{r Gap , echo = FALSE , include = FALSE}

Gaps_Ecosite <- TerrADat %>% subset(EcologicalSiteId == EcoSite) %>% 
                dplyr::select(GapCover_25_50 , GapCover_51_100 , GapCover_101_200 , GapCover_200_plus , GapCover_25_plus)

#Getting in format
Gaps_Ecosite_Tall <- gather(Gaps_Ecosite , key = Gap_Class_cm , value = Percent)

#Plot prep
Gaps_Plot <- ggplot(data = Gaps_Ecosite_Tall , aes(x = Gap_Class_cm , y = Percent)) + 
                                         labs(y = "Percent" , x = "Gap Size Class (cm)") +
                                         geom_boxplot() + coord_flip() + geom_jitter(width = 0.1) +
                                         theme_light() + theme(axis.title.x = element_text(vjust=-4) ,
                                                         axis.title.y = element_text(hjust=-5)) +
                                         theme(axis.text.y = element_blank() , axis.ticks.y = element_blank() , 
                                         axis.line.y = element_blank()) + theme(panel.grid.major.y = element_blank()) +
                                         facet_grid(rows = vars(Gap_Class_cm) , switch = "y" , 
                                         scales = "free_y" , drop = TRUE) 
#Table

EcoSiteGaps_Summary <- Gaps_Ecosite_Tall %>% group_by(Gap_Class_cm) %>%
                       summarize(AveragePercentCover = mean(Percent) , 
                                 StandardDeviation = sd(Percent),
                                 MinPercentCover = min(Percent) ,
                                 MaxPercentCover = max(Percent)) %>%
                                 mutate_if(is.numeric, round , digits = 2)
```

##
## Canopy Gap Size Class Plot <a name = "gapplot"></a>

```{r Gap plot , echo = FALSE , include = TRUE , fig.height = 7 , fig.width= 8}

Gaps_Plot

```

## Canopy Gap Size Class Summary Table <a name = "gaptable"></a>

```{r Gap summary , echo = FALSE , include = TRUE}

EcoSiteGaps_Summary %>%  DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)

```


# 9. Soil Stability  {.tabset .tabset-fade .tabset-pills}

Soil stability provides information on soil structure development and resistance to erosion. The soil stability test measures the soil's stability when exposed to rapid wetting, and reflects soil biotic integrity (see page 47 in the [Monitoring Manual](https://www.landscapetoolbox.org/wp-content/uploads/2016/02/MMGSSE_20170614.pdf).)

```{r soil stab  , echo = FALSE , include = FALSE}


SoilStability_EcoSite <- TerrADat %>% subset(EcologicalSiteId == EcoSite) %>% dplyr::select(SoilStability_All , SoilStability_Protected , SoilStability_Unprotected)


SoilStability_EcoSite_Tall <- gather(SoilStability_EcoSite , key = Veg , value = Rating)

Soil_Stab_Summary <- SoilStability_EcoSite_Tall %>% group_by(Veg) %>% summarize(AverageSoilStability = mean(Rating , na.rm = TRUE) , 
                                                    StandardDeviation = sd(Rating , na.rm = TRUE) ,
                                                    MinSoilStability = min(Rating , na.rm = TRUE) ,
                                                    MaxSoilStability = max(Rating, na.rm = TRUE)) %>%
                                                    mutate_if(is.numeric, round , digits = 2)

SoilStab_Names <- c("SoilStability_All" = "All" , "SoilStability_Protected" = "Protected" , "SoilStability_Unprotected" = "Unprotected")

Soil_Stab_Plot <- ggplot(data = SoilStability_EcoSite_Tall , aes(x = Veg , y = Rating)) +
                         labs(x = "Veg Cover" , y = "Soil Stability Rating") +
                         geom_boxplot() + coord_flip() + geom_jitter(width = 0.1) +
                         theme_light() + theme(axis.title.x = element_text(vjust=-4) ,
                                         axis.title.y = element_text(hjust=-5)) + 
                         theme(axis.text.y = element_blank() , axis.ticks.y = element_blank() , 
                         axis.line.y = element_blank()) + theme(panel.grid.major.y = element_blank()) +
                         facet_grid(rows = vars(Veg) , switch = "y" , 
                         scales = "free_y" , drop = TRUE , labeller = as_labeller(SoilStab_Names))

```

##
## Soil Stability Summary Plot 

```{r soil stab plot , echo = FALSE , include = TRUE , fig.height = 4 , fig.width = 10}

Soil_Stab_Plot

```

## Soil Stability Summary Table

```{r soil stab table , echo = FALSE , include = TRUE}

Soil_Stab_Summary %>%  DT::datatable(extensions = 'Buttons', filter = "top" , options = list(scrollX = TRUE , 
                          dom = 'Bfrtip',
                          buttons = 
                          list(list(
                          extend = 'collection',
                          buttons = c('csv', 'excel'),
                          text = 'Download Table'))) , rownames = FALSE)

```




