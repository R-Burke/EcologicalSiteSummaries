---
title: "Ecological Site Summaries using AIM & LMF Data" 
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
---

```{r setup, include=FALSE}
library(flexdashboard)
knitr::opts_chunk$set(echo = FALSE , message = FALSE , warning = FALSE)
```


```{r data prep, echo = FALSE , include = FALSE }

#Load all the data and required packages
library(tidyverse)
library(knitr)
library(kableExtra)
library(leaflet)
library(patternplot)
library(magrittr)
library(rgdal)
library(RColorBrewer)
library(units)
library(sp)
library(sf)
library(rworldmap)
library(rworldxtra)
library(raster)
library(plotly)


#Direct to data
TerrADatPath <- "~/GDBs/SDE_Export.gdb"
                #The state species list table should also live in this geodatabase

#Define your state

#Define your ecological site

EcoSite <- c("R023XF082CA")

TerrADat <- rgdal::readOGR(dsn = TerrADatPath , "TerrADat")

LMF <- rgdal::readOGR(dsn = TerrADatPath , "LMF")

TerrADat_Species <- rgdal::readOGR(dsn = TerrADatPath , "TerrADatSpeciesIndicators")

LMF_Species <- rgdal::readOGR(dsn = TerrADatPath , "LMFSpeciesIndicators")

#Save as a dataframe

TerrADat <- as.data.frame(TerrADat)

LMF <- as.data.frame(LMF)

TerrADat_Species <- as.data.frame(TerrADat_Species)

LMF_Species <- as.data.frame(LMF_Species)

LMF_EcoSite <- LMF %>% mutate(EcologicalSiteId2 = paste0("R" , LMF$EcologicalSiteId)) %>% dplyr::select(-EcologicalSiteId) 

LMF <- LMF_EcoSite %>% rename(EcologicalSiteId = EcologicalSiteId2)


#Bind LMF and TerrADat

TerrADat[setdiff(names(LMF) , names(TerrADat))] <- NA
LMF[setdiff(names(TerrADat), names(LMF))] <- NA

TDat_LMF <- rbind(TerrADat , LMF)

#Bind LMF and TerrADat Species Indicators

#First need names to match, TDat species got cut off (comment this out if did not first export to shapefile)

TerrADat_Species <- TerrADat_Species %>% rename(AH_SpeciesCover = AH_Species , Hgt_Species_Avg = Hgt_Specie , AH_SpeciesCover_n  = AH_Speci_1 , 
                                                Hgt_Species_Avg_n = Hgt_Spec_1 , GrowthHabit = GrowthHabi , GrowthHabitSub = GrowthHa_1 , 
                                                SpeciesState = SpeciesSta , created_user = created_us , created_date = created_da , 
                                                last_edited_user = last_edite , laste_edited_date = last_edi_1 )

#place NAs in non-matching columns
LMF_Species[setdiff(names(TerrADat_Species) , names(LMF_Species))] <- NA
TerrADat_Species[setdiff(names(LMF_Species), names(TerrADat_Species))] <- NA

Species_indicator <- rbind(TerrADat_Species , LMF_Species)

##Caption to use in your tables and plots

Caption <- paste0("Cover Summaries for Ecological Site" , EcoSite) 

#Subset your ecological site and state

#Pull out year for map


TDat_LMF_plots_Year <- separate(TDat_LMF, DateEstablished , into = c("Year" , "Month" , "Day"), sep = "/") %>% 
                    filter(!is.na(Year)) %>% filter(!is.na(Latitude_NAD83)) %>%
                    filter(!Latitude_NAD83 <= 1) %>% arrange(EcologicalSiteId) #Sorting this for the map and remove 0,0 lat lon


#Subset based on EcologicalSiteId

EcoSitePlots <- TDat_LMF[TDat_LMF[["EcologicalSiteId"]] %in% EcoSite, ] #for non-species indicators

EcoSite_PKs <- EcoSitePlots$PrimaryKey

#Keeping only the plots from accumulated species that match our EcoSite

Species_plots_ecosite <- Species_indicator[(Species_indicator[["PrimaryKey"]] %in% EcoSite_PKs), ]
Species_plots_ecosite <- Species_plots_ecosite %>% mutate(Tally = 1) #For getting sample size in species indicators

###That's all the subsetting necessary

#Create list of ecological sites and states for Shiny app

EcoSiteId <- TDat_LMF_plots_Year$EcologicalSiteId

State <- TDat_LMF_plots_Year$State

#Setting aesthetics for map
#Set colors based on ecological site id, date, etc. This is flexible

Pal_EcoSite <- colorFactor(palette = 'YlOrRd' , domain = TDat_LMF_plots_Year$EcologicalSiteId)

Pal_Date <- colorFactor(palette = 'Greys' , domain = TDat_LMF_plots_Year$Year)

Pal_EcoSiteID <- colorFactor(palette = "Red" , domain = EcoSite)

EcoSite_All <- TDat_LMF_plots_Year$EcologicalSiteId

Year <- TDat_LMF_plots_Year$Year

EcoSite_All <- as.character(EcoSite_All) #for if we want to add all ecosites to the legend
```

Page 1 , Introduction
===================================== 

Column {data-width=600}
-----------------------------------------------------------------------

```{r plots per year , echo = FALSE , include = FALSE}

Plots <- c("Plots")

Year_Palette <- c("2008" = "grey97" , "2009" = "grey87" , "2010" = "grey77" , "2011" = "grey70" , "2012" = "grey65" , 
                  "2013" = "grey60" , "2014" = "grey50" , "2015" = "grey45" , "2016" = "grey40" , "2017" = "grey35" ,
                  "2018" = "grey30" , "2019" = "grey25" , "2020" = "grey20" , "2021" = "grey15")

Plots_Simple <- TDat_LMF_plots_Year %>% dplyr::select(PrimaryKey , Year , EcologicalSiteId) %>% mutate(Plots = Plots) %>%
                arrange(Year)

Plots_Simple_EcoSite <- Plots_Simple[Plots_Simple[["EcologicalSiteId"]] %in% EcoSite, ] 

PlotsPerYear_Total <- ggplot(Plots_Simple , aes(Plots)) +
                geom_bar(stat = "count" , position = position_stack(reverse = TRUE) , 
                         aes(fill = Year) , width = .2 , ) +
                scale_fill_manual(values = Year_Palette) +
                coord_flip() + theme(axis.text.y = element_blank())


PlotsPerYear_EcoSite <- ggplot(Plots_Simple_EcoSite , aes(Plots)) +
                geom_bar(stat = "count" , position = position_stack(reverse = TRUE) , 
                         aes(fill = Year , text = EcologicalSiteId) , width = .2 , ) +
                scale_fill_manual(values = Year_Palette) +
                coord_flip() + theme(axis.text.y = element_blank())

EcologicalSitesPerYear <- ggplot(Plots_Simple , aes(EcologicalSiteId))+
                geom_bar(stat = "count" , position = position_stack(reverse = TRUE) , 
                         aes(fill = Year) ) +
                scale_fill_manual(values = Year_Palette) +
                coord_flip() 


```


### Plots Per Year , Total

```{r plots figure , echo = FALSE , include = TRUE , fig.height = 3 , fig.width = 8 }

PlotsPerYear_Total <- ggplotly(PlotsPerYear_Total) 
#ggtitle("Total Plots Per Year, AIM & LMF")
PlotsPerYear_Total

```

### Plots Per Year , Ecological Site of Interest

```{r plots figure 2 , echo = FALSE , include = TRUE , fig.height = 3 , fig.width = 8}

PlotsPerYear_EcoSite <- ggplotly(PlotsPerYear_EcoSite) 
#ggtitle(paste0("Plots Per Year in Ecological Site: " , EcoSite))
PlotsPerYear_EcoSite

```


Column {.tabset data-width=400}
-----------------------------------------------------------------------

### About Ecological Sites 

The U.S. Department of Agriculture Natural Resources Conservation Service (NRCS) defines ecological sites as "a distinctive kind of land with specific physical characteristics that differs from other kinds of land in its ability to produce a distinctive kind and amount of vegetation" ([USDAâ€“NRCS, 2006](https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/landuse/rangepasture/?cid=stelprdb1068392)). Ecological sites determine not only the ecological potential of a site, but also how a site can respond to natural disturbance and management actions. Ecological sites have been delineated for many areas using physical and biotic features and are linked to soil map units. Soils, climate, hydrology, geology, physiographic features, plants species occurrences, plant community composition, annual biomass production, and plant-wildlife interactions all contribute to the proerties of ecological sites.  Ecological Site Descriptions (ESDs) describe the underlying factors associated with a specific ecological site, as well as different ecological states within a given site based on factors such as grazing, fire, drought, and other management actions. For an example of an ESD, see [EDIT Jornada](https://edit.jornada.nmsu.edu/page?content=class-description&catalog=3&spatial=84&class=5802#top-bookmark). \

### Ecological Site Summary

The overall status of monitoring data within an ecological site can be described with an Ecological Site Summary (ESS). At the site level, ecological site summaries generated from monitoring data can tell us about the condition and health of ecological sites based on indicators such as cover by structure and functional group, species dominance, species occurrences, and canopy gap measurements. Identifying individual plot's or region's ecological states allows us to not only determine the degree of departure from the corresponding reference ecological states, but also to inform management and restoration actions accordingly by determining the best pathway to a less degraded state. For more on state and transition models (STMs), see see [Bestelmeyer et al., 2017](https://link.springer.com/content/pdf/10.1007%2F978-3-319-46709-2_9.pdf). A major data source for developing these summaries is the Assessment, Inventory, and Monitoring Program. The AIM program includes almost 25,000 plots throughout the western United States (*see* [AIM Data Portal](https://blm-egis.maps.arcgis.com/apps/webappviewer/index.html?id=930fff59dcd1497f87447a655b59747e)) stored in the Terrestrial AIM Database (TerrADat). Data garnered from AIM plots is both generalizable and scalable and thus applicable to management decisions at both local and national levels. \

Ecological site summaries are generated using an [R Markdown script](https://github.com/R-Burke/EcologicalSiteSummaries/blob/master/EcologicalSiteSummaryReport_09032019.Rmd). Because this is an automatied process, ESS can be continually updated as new data becomes available each year or as lines of inquiry shift. This ESS information can be included in decision making processes for BLM managers, as it can help inform land use plans, grazing permit renewals, shrub or invasive species treatments, and/or seed menu development for ecological restoration and reclamation. In cases where ESDs are not developed, grouping AIM data by other features can provide similar information, and potentially lead to the development of new ESDs. It may be informative to group by features such as watershed units, soil map units, biophysical settings, or grazing allotments.\


### Plot Map

Below is a map of AIM & LMF plots surveyed to date. 
Plots in our ecological site of interest are highlighted in red.

```{r map , echo = FALSE , include = FALSE}


Map <- leaflet(height = 650 , width = 650)

Map <- addTiles(Map) %>% addCircleMarkers(lng = ~Longitude_NAD83 , lat = ~Latitude_NAD83 , radius = 3 , 
                                          popup = ~EcologicalSiteId,
                                          color = ~Pal_Date(Year) , 
                                          fillOpacity = .5 , group = Year , 
                                          data = TDat_LMF_plots_Year) %>% 
                                          addCircleMarkers(lng = ~Longitude_NAD83 , lat = ~Latitude_NAD83 , 
                                                           radius = 3 , 
                                                           fillOpacity = 0.5 , 
                                                           popup = ~EcologicalSiteId ,
                                                           color = "red" , group = EcoSite , 
                                                           data = EcoSitePlots) %>% 
                                          addLayersControl(overlayGroups = c(EcoSite , Year) ,
                                          options = layersControlOptions(collapsed = TRUE)) %>%
                                          addLegend(pal = Pal_Date , values = TDat_LMF_plots_Year$Year , opacity = 1 , group = Year) %>%
                                          addLegend(pal = Pal_EcoSiteID , values = EcoSite , opacity = 1 , group = EcoSite)
                                          

```

```{r interactive map, echo = FALSE , include = TRUE}

Map

```





